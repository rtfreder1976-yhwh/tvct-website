---
interface Props {
  city: string;
  state: string;
  lat: number;
  lng: number;
  zoom?: number;
  serviceRadius?: number; // in miles
  neighborhoods?: string[];
  mapId?: string;
}

const {
  city,
  state,
  lat,
  lng,
  zoom = 11,
  serviceRadius = 15,
  neighborhoods = [],
  mapId = 'service-area-map'
} = Astro.props;

// Convert miles to meters for the circle radius
const radiusMeters = serviceRadius * 1609.34;
---

<div class="location-map-container">
  <div
    id={mapId}
    class="w-full h-[400px] rounded-xl shadow-lg border border-gray-200"
    data-lat={lat}
    data-lng={lng}
    data-zoom={zoom}
    data-radius={radiusMeters}
    data-city={city}
    data-state={state}
  ></div>

  <div class="mt-4 flex flex-wrap gap-2 justify-center">
    <div class="flex items-center text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-[#FFA985]/30 border-2 border-[#FFA985] mr-2"></span>
      {serviceRadius}-Mile Service Area
    </div>
    <div class="flex items-center text-sm text-gray-600">
      <span class="w-3 h-3 rounded-full bg-[#FFA985] mr-2"></span>
      {city} Center
    </div>
  </div>
</div>

<script>
  // Initialize maps when DOM is ready
  function initLocationMaps() {
    const mapContainers = document.querySelectorAll('[id^="service-area-map"]');

    mapContainers.forEach((container) => {
      const mapElement = container as HTMLElement;
      const lat = parseFloat(mapElement.dataset.lat || '0');
      const lng = parseFloat(mapElement.dataset.lng || '0');
      const zoom = parseInt(mapElement.dataset.zoom || '11');
      const radius = parseFloat(mapElement.dataset.radius || '24000');
      const city = mapElement.dataset.city || '';
      const state = mapElement.dataset.state || '';

      // Skip if already initialized
      if (mapElement.dataset.initialized === 'true') return;

      const center = { lat, lng };

      // Create map
      const map = new google.maps.Map(mapElement, {
        center,
        zoom,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        zoomControl: true,
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          },
          {
            featureType: 'transit',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      // Add service area circle
      new google.maps.Circle({
        strokeColor: '#FFA985',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FFA985',
        fillOpacity: 0.15,
        map,
        center,
        radius
      });

      // Add center marker
      new google.maps.Marker({
        position: center,
        map,
        title: `${city}, ${state}`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: '#FFA985',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 3
        }
      });

      // Add info window
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="padding: 8px; font-family: system-ui, sans-serif;">
            <h3 style="margin: 0 0 4px 0; font-weight: 600; color: #333;">${city}, ${state}</h3>
            <p style="margin: 0; color: #666; font-size: 14px;">The Valley Clean Team Service Area</p>
          </div>
        `
      });

      // Show info window on marker click
      const marker = new google.maps.Marker({
        position: center,
        map,
        title: `${city}, ${state}`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: '#FFA985',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 3
        }
      });

      marker.addListener('click', () => {
        infoWindow.open(map, marker);
      });

      mapElement.dataset.initialized = 'true';
    });
  }

  // Load Google Maps API dynamically
  function loadGoogleMapsAPI() {
    if (typeof google !== 'undefined' && google.maps) {
      initLocationMaps();
      return;
    }

    // Check if script is already loading
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
      return;
    }

    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyA5HPrZ7M7l7dI2cWmoY-_VPzUNtk574B4&callback=initLocationMaps`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }

  // Expose init function globally for callback
  (window as any).initLocationMaps = initLocationMaps;

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
  } else {
    loadGoogleMapsAPI();
  }
</script>

<style>
  .location-map-container {
    width: 100%;
  }
</style>
