---
import Icon from './Icon.astro';

interface Props {
  formId?: string;
  city?: string;
  state?: string;
  serviceName?: string;
  subtitle?: string;
}

const {
  formId = 'quote-form',
  city = '',
  state = 'AL',
  serviceName = '',
  subtitle = "Fill out in 60 seconds"
} = Astro.props;

const locationValue = city ? `${city}, ${state}` : '';
const sourceValue = serviceName ? `${serviceName} - ${city}` : city ? `${city} Landing Page` : 'Website';
const buttonText = city ? `Get My Free ${city} Quote` : 'Get My Free Quote';
const uniqueId = formId.replace(/[^a-zA-Z0-9]/g, '-');
---

<form id={formId} class="quote-form">
  <div class="mb-4">
    <label for={`${uniqueId}-phone`} class="block text-gray-700 mb-2">Phone <span class="text-[#FFA985]">*</span></label>
    <input type="tel" id={`${uniqueId}-phone`} name="phone" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" placeholder="256-826-1100" required aria-required="true" />
  </div>
  <div class="mb-4">
    <label for={`${uniqueId}-service`} class="block text-gray-700 mb-2">Service Type <span class="text-[#FFA985]">*</span></label>
    <select id={`${uniqueId}-service`} name="service" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" required aria-required="true">
      <option value="">Select a Service</option>
      <option value="Deep Cleaning">Deep Cleaning</option>
      <option value="Regular Cleaning">Regular Cleaning</option>
      <option value="Move In/Out Cleaning">Move In/Out Cleaning</option>
      <option value="Post-Construction Cleaning">Post-Construction Cleaning</option>
      <option value="Commercial/Office Cleaning">Commercial/Office Cleaning</option>
      <option value="Event Cleaning">Event Cleaning</option>
      <option value="Green Cleaning">Green Cleaning</option>
      <option value="Airbnb Cleaning">Airbnb Cleaning</option>
    </select>
  </div>
  <div class="mb-4">
    <label for={`${uniqueId}-sqft`} class="block text-gray-700 mb-2">Square Footage <span class="text-[#FFA985]">*</span></label>
    <select id={`${uniqueId}-sqft`} name="square_footage" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" required aria-required="true">
      <option value="">Select Home Size</option>
      <option value="Under 1,000 sq ft">Under 1,000 sq ft</option>
      <option value="1,000 - 1,500 sq ft">1,000 - 1,500 sq ft</option>
      <option value="1,500 - 2,000 sq ft">1,500 - 2,000 sq ft</option>
      <option value="2,000 - 2,500 sq ft">2,000 - 2,500 sq ft</option>
      <option value="2,500 - 3,000 sq ft">2,500 - 3,000 sq ft</option>
      <option value="3,000 - 4,000 sq ft">3,000 - 4,000 sq ft</option>
      <option value="4,000 - 5,000 sq ft">4,000 - 5,000 sq ft</option>
      <option value="Over 5,000 sq ft">Over 5,000 sq ft</option>
    </select>
  </div>
  <div class="mb-4">
    <label for={`${uniqueId}-name`} class="block text-gray-700 mb-2">Name <span class="text-[#FFA985]">*</span></label>
    <input type="text" id={`${uniqueId}-name`} name="name" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" placeholder="Your Name" required aria-required="true" />
  </div>
  <div class="mb-4">
    <label for={`${uniqueId}-email`} class="block text-gray-700 mb-2">Email <span class="text-gray-400 text-sm">(optional)</span></label>
    <input type="email" id={`${uniqueId}-email`} name="email" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" placeholder="your@email.com" />
  </div>
  <div class="mb-4">
    <label for={`${uniqueId}-date`} class="block text-gray-700 mb-2">Preferred Date <span class="text-gray-400 text-sm">(optional)</span></label>
    <input type="date" id={`${uniqueId}-date`} name="preferred_date" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" />
  </div>
  <div class="mb-4">
    <label for={`${uniqueId}-message`} class="block text-gray-700 mb-2">Additional Details <span class="text-gray-400 text-sm">(optional)</span></label>
    <textarea id={`${uniqueId}-message`} name="message" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:border-[#FFA985] focus:ring-2 focus:ring-[#FFA985]/20" rows="2" placeholder="Tell us about your home..."></textarea>
  </div>
  <input type="hidden" name="location" value={locationValue}>
  <input type="hidden" name="source" value={sourceValue}>
  <button type="submit" class="quote-submit-btn btn-primary w-full py-4 rounded-lg text-lg font-semibold shadow-lg">
    {buttonText}
  </button>
  <p class="text-center text-xs text-gray-500 mt-3">
    <Icon name="lock" class="w-3 h-3 mr-1 inline" /> Your information is secure. We'll call within 2 hours.
  </p>
  <div class="quote-form-message hidden text-center p-4 rounded-lg mt-3"></div>
</form>

<script>
  document.querySelectorAll('.quote-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const submitBtn = form.querySelector('.quote-submit-btn');
      const messageDiv = form.querySelector('.quote-form-message');
      const originalText = submitBtn?.textContent || 'Get My Free Quote';

      const formData = {
        name: form.name?.value || '',
        email: form.email?.value || '',
        phone: form.phone?.value || '',
        service: form.service?.value || '',
        square_footage: form.square_footage?.value || '',
        location: form.location?.value || '',
        preferred_date: form.preferred_date?.value || '',
        message: form.message?.value || '',
        source: form.source?.value || 'Website',
        page_url: window.location.href
      };

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span>Sending...';
      }

      try {
        const response = await fetch('/api/submit-form', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          if (messageDiv) {
            messageDiv.className = 'quote-form-message text-center p-4 rounded-lg bg-green-100 text-green-800';
            messageDiv.innerHTML = '✓ Thank you! We\'ll be in touch within 2 hours.';
            messageDiv.classList.remove('hidden');
          }
          form.reset();
        } else {
          throw new Error(result.error || 'Submission failed');
        }
      } catch (error) {
        if (messageDiv) {
          messageDiv.className = 'quote-form-message text-center p-4 rounded-lg bg-red-100 text-red-800';
          messageDiv.innerHTML = '⚠ Something went wrong. Please call us directly.';
          messageDiv.classList.remove('hidden');
        }
      }

      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  });
</script>
